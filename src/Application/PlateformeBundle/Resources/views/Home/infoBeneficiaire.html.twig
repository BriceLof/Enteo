<thead>
<tr>
    <th>Nom</th>
    <th>Prénom</th>
    <th>Ville Mer</th>
    <th>Date Mer</th>
    <th>Heure Mer</th>
    <th>Tél</th>
    <th>Email</th>
    <th>Domaine Vae</th>
    <th>Diplôme visé</th>
    <th>Heure rappel</th>
    <th>Consultant</th>
</tr>
</thead>
<tbody>
<tr>
    <td><a title="Voir la fiche du bénéficiaire" alt="Voir la fiche du bénéficiaire" target="_blank" href="{{ path('application_show_beneficiaire', {'id': beneficiaire.id}) }}" id="{{ beneficiaire.id }}"><b>{{ beneficiaire.nomConso|capitalize }}</b></a></td>
    <td><b>{{ beneficiaire.prenomConso|capitalize }}</b></td>
    <td>{{ beneficiaire.villeMer.nom|capitalize }}</td>
    <td>{{ beneficiaire.dateHeureMer|date("d/m/Y") }}</td>
    <!-- heure de la première news du bénéficiaire, cad l'heure de la confirmation de la mer à qq secondes près -->
    <td>{{ beneficiaire.news[0].dateHeure|date("H:i") }}</td>
    <td><b>{{ beneficiaire.telConso }}</b></td>
    <td>{{ beneficiaire.emailConso }}</td>
    <td>{{ beneficiaire.domaineVae|capitalize }}</td>
    <td>{{ beneficiaire.diplomeVise|capitalize }}</td>
    <td>{{ beneficiaire.heureRappel|capitalize }}</td>
    {% if beneficiaire.consultant is not null %}
        <td>
            <b>{{ beneficiaire.consultant.nom~' '~beneficiaire.consultant.prenom }}</b>
            {#
                {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_COMMERCIAL') or is_granted('ROLE_GESTION') %}
                    <span class="modifierConsultant maj" data-toggle="modal" data-target="#myModal{{ beneficiaire.id }}">Modifier</span>
                {% endif %}
             #}
        </td>
    {% else %}
        <td>
            <b>Pas encore de consultant</b>
            {#
                {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_COMMERCIAL') or is_granted('ROLE_GESTION') %}
                    <span class="modifierConsultant" data-toggle="modal" data-target="#myModal{{ beneficiaire.id }}">Ajouter un consultant</span>
                {% endif %}
            #}
        </td>
    {% endif %}
</tr>

<div class="modal fade" id="myModal{{ beneficiaire.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">Changement de Consultant</h4>
            </div>
            <form action="{{ path('application_edit_consultant_beneficiaire', { 'id' : beneficiaire.id }) }}" method="post">
                {{ render(controller("ApplicationPlateformeBundle:Beneficiaire:editConsultant",{'id': beneficiaire.id})) }}
            </form>
        </div>
    </div>
</div>

{% if(beneficiaire.news | length > 0) %}
    {% set derniere_news = beneficiaire.news[beneficiaire.news | length -1] %}
{% endif %}
<!--<tr>
    <td colspan=11></td>
</tr>-->
<tr>
    <th colspan=2>Nombre total appel</th>
    <th colspan=2>Dernier appel</th>
    <th colspan=5>Dernière news</th>
    <th>Statut</th>
    <th>Détail statut</th>
</tr>
<tr>
    <td colspan=2 title="Ajouter une news" class="btn_formulaire_add_news" id="{{beneficiaire.id}}" data-toggle="modal" data-target="#block_formulaire_ajout_new_{{beneficiaire.id}}"><span style="color:red"><b>{% if beneficiaire.nbAppelTel == null %}0{% endif %} {{ beneficiaire.nbAppelTel }}</b></span> appel{% if beneficiaire.nbAppelTel > 1 %}s{% endif %}</td>
    <td colspan=2>
        {{ beneficiaire.news | length > 0 ? derniere_news.dateHeure|date("d/m/Y") ~ ' à' : '' }}
        {{ beneficiaire.news | length > 0 ? derniere_news.dateHeure|date("H:i") : ''}}
    </td>
    <td colspan=5>
        {% if(beneficiaire.nouvelle | length > 0) %}
            {% set last_nouvelle = beneficiaire.nouvelle[beneficiaire.nouvelle | length -1] %}
            {{ 
                last_nouvelle.utilisateur.prenom |slice(0,1)| capitalize ~'. '~last_nouvelle.utilisateur.nom | capitalize ~', le '~
                last_nouvelle.date | date("d/m/Y à H:i")~' : '~ ((last_nouvelle.message | length > 130) ? last_nouvelle.message | slice(0,130)~'...' :  last_nouvelle.message)
            }}
            {% if(beneficiaire.nouvelle | length > 1) %}<button data-toggle="modal" class="voirPlusNouvelle" id="{{beneficiaire.id}}" data-target="#voirPlusNouvelle_{{beneficiaire.id}}">Voir +</button>{% endif %}
        {% endif %}
    </td>
    <td><b>{{ beneficiaire.news | length > 0 ? derniere_news.statut.nom : '' }}</b></td>
    <td>{{ beneficiaire.news | length > 0 ? derniere_news.detailStatut.detail : '' }}</td>
</tr>
</tbody>


<aside class="modal fade" id="voirPlusNouvelle_{{beneficiaire.id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">News | 
                    <span class="text-danger">{{ beneficiaire.civiliteConso|capitalize ~ ' ' ~ beneficiaire.nomConso|capitalize ~ ' ' ~ beneficiaire.prenomConso|capitalize}}</span>
                </h4>
            </div>
            <div class="modal-body" id="listeNouvelle_{{beneficiaire.id}}">

            </div>
        </div>
    </div>
</aside>